<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>stpr.transformer &#8212; Stpr</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic_mod.css?v=9b2032db" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/style.css?v=b283b5c5" />
    <link rel="stylesheet" type="text/css" href="../../_static/fixes.css?v=40ebb8c7" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@200..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Radio+Canada:ital,wght@0,300..700;1,300..700&display=swap" rel="stylesheet">

    
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/main.js?v=6c1a4791"></script>
    <script src="../../_static/js/theme.js"></script>
    <script src="../../_static/js/petite-vue.js"></script>

    <link rel="canonical" href="/stpr/_modules/stpr/transformer.html" />
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body class="page-_modules/stpr/transformer docpage" data-dark_mode_code_blocks="true">
    <div id="top_nav">
        

        <nav>
            
                
            

            <h1><a href="/stpr" title="Go to homepage">Stpr</a></h1>


            <ul class="top-menu">
    <li><a href="/stpr/install.html" class="not-active">Install</a></li>
    <li><a href="/stpr/docs/index.html" class="active">Documentation</a></li>
</ul>
                <p class="mobile_search_link">
                    <a href="../../search.html" title="Search">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 65 64" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2">
                            <path d="M14.873 40.009c-2.315-3.943-3.642-8.532-3.642-13.429C11.231 11.91 23.141 0 37.811 0s26.58 11.91 26.58 26.58-11.91 26.58-26.58 26.58a26.44 26.44 0 0 1-14.277-4.161L9.739 62.794a3.12 3.12 0 0 1-4.413 0L.913 58.382c-1.217-1.218-1.217-3.196 0-4.413l13.96-13.96zM37.811 8.054c10.225 0 18.526 8.301 18.526 18.526s-8.301 18.526-18.526 18.526-18.526-8.301-18.526-18.526S27.586 8.054 37.811 8.054z" fill="#fff" />
                        </svg>
                    </a>
                </p>
            
                <div class="searchbox_wrapper">
                    
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
                </div>
            

            <a href="https://github.com/hategan/stpr" class="gh">GitHub</a>
        </nav>
    </div>

        
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/primitives.html">Concurrency Primitives</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/types.html">Stpr Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/functions.html">Stpr Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/reactives.html">Reactive Variables and Functions</a></li>
</ul>

<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for stpr.transformer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">asyncio</span> <span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">AbstractAsyncContextManager</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Coroutine</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Iterable</span>

<span class="kn">from</span> <span class="nn">stpr._astdump</span> <span class="kn">import</span> <span class="n">astdump</span><span class="p">,</span> <span class="n">astdumps</span>
<span class="kn">from</span> <span class="nn">stpr._debug</span> <span class="kn">import</span> <span class="n">debug_print</span><span class="p">,</span> <span class="n">Color</span><span class="p">,</span> <span class="n">_ts</span><span class="p">,</span> <span class="n">DEBUG</span><span class="p">,</span> <span class="n">_print</span>

<span class="n">_SAFE_MODULES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">_SAFE_MODULES</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;stpr&#39;</span><span class="p">)</span>
<span class="n">_SAFE_MODULES</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;stpr.transformer&#39;</span><span class="p">)</span>
<span class="n">_SAFE_MODULES</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;stpr.types&#39;</span><span class="p">)</span>
<span class="n">_SAFE_MODULES</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;stpr.reactive&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Ref</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">_type</span>

    <span class="k">def</span> <span class="nf">is_coro</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_async_ctx_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__aenter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__aexit__&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;__aenter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;__aexit__&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_ctx_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__enter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__exit__&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;__enter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;__exit__&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Ref[</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_find_global</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_Ref</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_Ref</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_Ref</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_builtins</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No reference found for &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">CYAN</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_type</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;_type&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;_type&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_transform_with</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">node</span>

<span class="k">def</span> <span class="nf">_copy_params</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">field_name</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lineno&#39;</span><span class="p">,</span> <span class="s1">&#39;end_lineno&#39;</span><span class="p">,</span> <span class="s1">&#39;col_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;end_col_offset&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dst</span>


<span class="k">def</span> <span class="nf">_transform</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">sp_mod_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">_Transformer</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">sp_mod_name</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span>

<span class="k">def</span> <span class="nf">_is_async</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">outer_frame</span><span class="p">,</span> <span class="nb">locals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="n">_EXPR_ATTRS_LIST</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Dict</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Set</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;elts&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;comparators&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">JoinedStr</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">List</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;elts&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;elts&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">_EXPR_ATTRS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">NamedExpr</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;operand&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">IfExp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">ListComp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;elt&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">SetComp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;elt&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">DictComp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">FormattedValue</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;slice&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Starred</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">_EXPR_OPT_ATTRS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">FormattedValue</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;format_spec&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Slice</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">_EXPR_ATTRS_COMPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">ListComp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;generators&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">SetComp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;generators&#39;</span><span class="p">],</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">DictComp</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;generators&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">ExprType</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">has_heavy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">has_async</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_heavy</span> <span class="o">=</span> <span class="n">has_heavy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_async</span> <span class="o">=</span> <span class="n">has_async</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_coro</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">async_found</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_async</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">heavy_found</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_heavy</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">all_async</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_async</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_heavy</span>

    <span class="k">def</span> <span class="nf">all_heavy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_heavy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_async</span>

    <span class="k">def</span> <span class="nf">all_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_heavy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_async</span>

    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;ExprType&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_heavy</span> <span class="o">|=</span> <span class="n">other</span><span class="o">.</span><span class="n">has_heavy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_async</span> <span class="o">|=</span> <span class="n">other</span><span class="o">.</span><span class="n">has_async</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;ExprType&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">def</span> <span class="nf">_analyze_all</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">tr</span><span class="p">:</span> <span class="s1">&#39;_Transformer&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExprType</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ExprType</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">_analyze</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>


<span class="k">def</span> <span class="nf">_analyze</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="s1">&#39;_Transformer&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExprType</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ExprType</span><span class="p">()</span>
    <span class="n">expr</span><span class="o">.</span><span class="n">_a_type</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t</span>

    <span class="bp">cls</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span>

    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS_LIST</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS_LIST</span><span class="p">[</span><span class="bp">cls</span><span class="p">]:</span>
            <span class="n">sub_exprs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">_analyze_all</span><span class="p">(</span><span class="n">sub_exprs</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS</span><span class="p">[</span><span class="bp">cls</span><span class="p">]:</span>
            <span class="n">sub_expr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">_analyze</span><span class="p">(</span><span class="n">sub_expr</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">_EXPR_OPT_ATTRS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">_EXPR_OPT_ATTRS</span><span class="p">[</span><span class="bp">cls</span><span class="p">]:</span>
            <span class="n">sub_expr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sub_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="n">_analyze</span><span class="p">(</span><span class="n">sub_expr</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS_COMPS</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">_EXPR_ATTRS_COMPS</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
        <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">ifs</span><span class="p">,</span> <span class="n">comp_is_async</span><span class="p">)</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">comp_is_async</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">_analyze</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">_analyze_all</span><span class="p">(</span><span class="n">ifs</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">:</span>
        <span class="c1"># in principle we want to bring everything into a tree</span>
        <span class="c1"># of await coro, so if an expression is already that,</span>
        <span class="c1"># we don&#39;t need to do anything</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">heavy_found</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">is_coro</span><span class="p">():</span>
            <span class="n">t</span><span class="o">.</span><span class="n">async_found</span><span class="p">()</span>
            <span class="n">t</span><span class="o">.</span><span class="n">is_coro</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">heavy_found</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">t</span>


<span class="k">def</span> <span class="nf">_empty_ast_arguments</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="n">posonlyargs</span><span class="o">=</span><span class="p">[],</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">defaults</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwonlyargs</span><span class="o">=</span><span class="p">[],</span> <span class="n">kw_defaults</span><span class="o">=</span><span class="p">[])</span>


<span class="k">def</span> <span class="nf">_make_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="n">posonlyargs</span><span class="o">=</span><span class="p">[],</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span> <span class="n">defaults</span><span class="o">=</span><span class="p">[],</span>
                         <span class="n">kwonlyargs</span><span class="o">=</span><span class="p">[],</span> <span class="n">kw_defaults</span><span class="o">=</span><span class="p">[])</span>


<span class="k">def</span> <span class="nf">_make_names</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_clear_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;lineno&#39;</span><span class="p">):</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;lineno&#39;</span><span class="p">)</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;end_lineno&#39;</span><span class="p">)</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;col_offset&#39;</span><span class="p">)</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;end_col_offset&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
            <span class="n">_clear_lineno</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_copy_lineinfo</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lineno&#39;</span><span class="p">,</span> <span class="s1">&#39;end_lineno&#39;</span><span class="p">,</span> <span class="s1">&#39;col_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;end_col_offset&#39;</span><span class="p">]:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_wrap_in_async_proc</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">tr</span><span class="p">:</span> <span class="s1">&#39;_Transformer&#39;</span><span class="p">,</span>
                        <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;__sp_proc_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tr</span><span class="o">.</span><span class="n">next_tmp_index</span><span class="p">()</span>
    <span class="n">def_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">_make_args</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">body</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span> <span class="n">decorator_list</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">invoke_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">(</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
            <span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
            <span class="n">args</span><span class="o">=</span><span class="n">_make_names</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
            <span class="n">keywords</span><span class="o">=</span><span class="p">[]))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">def_ast</span><span class="p">,</span> <span class="n">invoke_ast</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_wrap_await</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_wrap_none</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">expr</span>


<span class="k">def</span> <span class="nf">_wrap_par</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;__sp_pctx&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                                       <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;_start&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">expr</span><span class="p">],</span> <span class="n">keywords</span><span class="o">=</span><span class="p">[])</span>


<span class="k">def</span> <span class="nf">_wrap_in_lambda</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="s1">&#39;_Transformer&#39;</span><span class="p">,</span>
                    <span class="n">wrapper</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrap_await</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">wrapper</span><span class="p">(</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
            <span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">sp_mod_name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                               <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;_run_sync&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
            <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">_empty_ast_arguments</span><span class="p">(),</span> <span class="n">body</span><span class="o">=</span><span class="n">expr</span><span class="p">)],</span>
            <span class="n">keywords</span><span class="o">=</span><span class="p">[]))</span>


<span class="k">def</span> <span class="nf">_sp_invoke</span><span class="p">(</span><span class="n">meth</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="s1">&#39;_Transformer&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="n">copy</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
    <span class="n">_copy_params</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">sp_mod_name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                           <span class="n">attr</span><span class="o">=</span><span class="n">meth</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">copy</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_ensure_async_expr_all</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">tr</span><span class="p">:</span> <span class="s1">&#39;_Transformer&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)):</span>
        <span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ensure_async_expr</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">l</span>


<span class="k">def</span> <span class="nf">_ensure_async_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="s1">&#39;_Transformer&#39;</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">wrapper</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrap_await</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures that the expression is either awaitable or simple, so that it can be run outside the</span>
<span class="sd">    thread pool.</span>
<span class="sd">        c = a + b -&gt; c = a + b</span>
<span class="sd">        c = H a + H b -&gt; c = A C(H a + H b)</span>
<span class="sd">        c = A a + A b -&gt; c = A a + a B</span>
<span class="sd">        c = H a + b -&gt; c = A C(H a + b)</span>
<span class="sd">        c = A a + b -&gt; c = A a + b</span>
<span class="sd">        c = A a + H b -&gt; c = A a + A C(H b)</span>

<span class="sd">    :param node:</span>
<span class="sd">    :param tr:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">_analyze</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_ensure_async_expr_r</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="n">wrapper</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_ensure_async_expr_r</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">tr</span><span class="p">:</span> <span class="s1">&#39;_Transformer&#39;</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">wrapper</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="n">_wrap_await</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="c1"># we know we have both async branches and heavy branches</span>
    <span class="c1"># we change heavy branches H x to await C(H x) at the thickest point while</span>
    <span class="c1"># adding await to all coro invocations</span>

    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">_a_type</span><span class="o">.</span><span class="n">all_simple</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_wrap_in_lambda</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expr</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">_a_type</span><span class="o">.</span><span class="n">all_heavy</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">_wrap_in_lambda</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>

    <span class="bp">cls</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="vm">__class__</span>

    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS_LIST</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS_LIST</span><span class="p">[</span><span class="bp">cls</span><span class="p">]:</span>
            <span class="n">sub_exprs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">_ensure_async_expr_all</span><span class="p">(</span><span class="n">sub_exprs</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_nodes</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS</span><span class="p">[</span><span class="bp">cls</span><span class="p">]:</span>
            <span class="n">sub_expr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">_ensure_async_expr</span><span class="p">(</span><span class="n">sub_expr</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_nodes</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">_EXPR_ATTRS_COMPS</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">_EXPR_ATTRS_COMPS</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
        <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">ifs</span><span class="p">,</span> <span class="n">comp_is_async</span><span class="p">)</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">comp_is_async</span><span class="p">:</span>
            <span class="nb">iter</span> <span class="o">=</span> <span class="n">_ensure_async_expr</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
            <span class="n">ifs</span> <span class="o">=</span> <span class="n">_ensure_async_expr_all</span><span class="p">(</span><span class="n">ifs</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">expr</span>


<span class="k">def</span> <span class="nf">_make_call</span><span class="p">(</span><span class="n">obj_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">obj_name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
            <span class="n">attr</span><span class="o">=</span><span class="n">method_name</span><span class="p">,</span>
            <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
        <span class="n">args</span><span class="o">=</span><span class="p">[]</span> <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">args</span><span class="p">],</span> <span class="n">keywords</span><span class="o">=</span><span class="p">[])</span>


<span class="k">def</span> <span class="nf">_assign</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())],</span>
                      <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ContextType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">SEQ</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PAR</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">DEF</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">_Local</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">awaited</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_param</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">used</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">awaited</span> <span class="o">=</span> <span class="n">awaited</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_param</span> <span class="o">=</span> <span class="n">is_param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="n">used</span>

<span class="k">class</span> <span class="nc">_Locals</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">awaited</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_param</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">used</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_Local</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">awaited</span><span class="p">,</span> <span class="n">is_param</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;Adding var </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">, awaited: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">awaited</span><span class="p">),</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_awaited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">awaited</span>

    <span class="k">def</span> <span class="nf">is_used</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">used</span>

    <span class="k">def</span> <span class="nf">is_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">is_param</span>

    <span class="k">def</span> <span class="nf">set_awaited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">awaited</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">set_used</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">type</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars</span>


<span class="k">class</span> <span class="nc">_Context</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="s1">&#39;_Context&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">_ContextType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">_ContextType</span><span class="o">.</span><span class="n">PAR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locals</span> <span class="o">=</span> <span class="n">_Locals</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span> <span class="o">!=</span> <span class="n">_ContextType</span><span class="o">.</span><span class="n">DEF</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locals</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">locals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locals</span> <span class="o">=</span> <span class="n">_Locals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">def_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">add_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">awaited</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_param</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">awaited</span><span class="p">,</span> <span class="n">is_param</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_awaited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">is_awaited</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_used</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">is_used</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">is_param</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_awaited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">set_awaited</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_used</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">set_used</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">get_type</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Ref</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">vars</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_Ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">get_type</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">var_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_Transformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outer_frame</span><span class="p">,</span> <span class="n">sp_mod_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outer_frame</span> <span class="o">=</span> <span class="n">outer_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_mod_name</span> <span class="o">=</span> <span class="n">sp_mod_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Ref</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_find_global</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_frame</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">_Context</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Ref</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ref</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_local</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Ref</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_local</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_member</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Ref</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ref</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_global</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">_Ref</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">_Ref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_member</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_enter_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">_ContextType</span> <span class="o">=</span> <span class="n">_ContextType</span><span class="o">.</span><span class="n">SEQ</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span> <span class="o">=</span> <span class="n">_Context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_exit_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Context</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enter_context</span><span class="p">(</span><span class="n">_ContextType</span><span class="o">.</span><span class="n">SEQ</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncWith</span><span class="p">()</span>
        <span class="n">_copy_params</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">new_node</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">new_node</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">wi</span><span class="o">.</span><span class="n">optional_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No variable allowed in parallel with statement&#39;</span><span class="p">)</span>
        <span class="n">wi</span><span class="o">.</span><span class="n">optional_vars</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;__sp_pctx&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_parallel</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">_fork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">wi</span><span class="o">.</span><span class="n">optional_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No variable allowed in fork with statement&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_fork</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">_parallelFor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Missing range argument to parallelFor&#39;</span><span class="p">)</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">awaited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="n">_make_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_mod_name</span><span class="p">,</span> <span class="s1">&#39;_to_aiter&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="n">afor</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFor</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="nb">iter</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">orelse</span><span class="o">=</span><span class="p">[])</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncWith</span><span class="p">()</span>
        <span class="n">wi</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">withitem</span><span class="p">()</span>
        <span class="n">wi</span><span class="o">.</span><span class="n">context_expr</span> <span class="o">=</span> <span class="n">_make_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_mod_name</span><span class="p">,</span> <span class="s1">&#39;parallel&#39;</span><span class="p">)</span>
        <span class="n">wi</span><span class="o">.</span><span class="n">optional_vars</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;__sp_pctx&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())</span>
        <span class="n">r</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">wi</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">afor</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enter_context</span><span class="p">(</span><span class="n">_ContextType</span><span class="o">.</span><span class="n">PAR</span><span class="p">)</span>
        <span class="n">afor</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_nodes</span><span class="p">(</span><span class="n">afor</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">exports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">var_names</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exports</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">afor</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Nonlocal</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exports</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">exports</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">var_names</span><span class="p">():</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_assign</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>

        <span class="n">afor</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">_wrap_in_async_proc</span><span class="p">(</span><span class="n">afor</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
        <span class="n">afor</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">_wrap_par</span><span class="p">(</span><span class="n">afor</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">crt_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">nodes</span>

    <span class="k">def</span> <span class="nf">next_tmp_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">def_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">def_index</span>

    <span class="k">def</span> <span class="nf">_new_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="n">with_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">withitem</span><span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_mod_name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                    <span class="n">attr</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
                    <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">],</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="n">with_ast</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">with_ast</span><span class="o">.</span><span class="n">end_lineno</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">with_ast</span>

    <span class="k">def</span> <span class="nf">_new_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_with</span><span class="p">(</span><span class="s1">&#39;seq&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_has_sp_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">decorator</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">decorator</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">fn</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enter_context</span><span class="p">(</span><span class="n">_ContextType</span><span class="o">.</span><span class="n">SEQ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Coroutine</span><span class="p">,</span> <span class="n">awaited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_sp_decorator</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">_copy_params</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">())</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">posonlyargs</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

                <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_nodes</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span>

            <span class="k">return</span> <span class="n">node</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exit_context</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_await</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">src</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="n">await_what</span> <span class="o">=</span> <span class="n">_sp_invoke</span><span class="p">(</span><span class="s1">&#39;_await&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">aw</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">(</span><span class="n">await_what</span><span class="p">)</span>
        <span class="n">_copy_lineinfo</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">aw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())],</span> <span class="n">value</span><span class="o">=</span><span class="n">aw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">get_type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">is_awaited</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span>

        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;Type for </span><span class="si">%s</span><span class="s1"> is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">type</span><span class="p">),</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_await</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">set_awaited</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">is_param</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">is_awaited</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt_nodes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_await</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">set_awaited</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">node</span>


    <span class="k">def</span> <span class="nf">_is_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mod</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">_SAFE_MODULES</span>

    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="c1"># heavy(heavy) -&gt;</span>
        <span class="c1">#   def __sp_fn_n():</span>
        <span class="c1">#       heavy(heavy)</span>
        <span class="c1">#   await sp._call(__sp_fn_n)</span>
        <span class="c1">#</span>
        <span class="c1"># heavy(simple) -&gt;</span>
        <span class="c1">#   await sp._call(heavy, simple)</span>
        <span class="c1">#</span>
        <span class="c1"># coro(heavy) -&gt;</span>
        <span class="c1">#   __sp_tmp_n = sp._call(heavy)</span>
        <span class="c1">#   await coro(__sp_tmp_n)</span>

        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;Call </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">astdumps</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">),</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">(</span><span class="n">_sp_invoke</span><span class="p">(</span><span class="s1">&#39;_call&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">_SP_FNS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_parallel_fn</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">race</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_race_fn</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unhandled sp function: </span><span class="si">{</span><span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">is_coro</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_safe</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_safe</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_safe</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">value</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;_type&#39;</span><span class="p">):</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">_type</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">Coroutine</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">(</span><span class="n">_sp_invoke</span><span class="p">(</span><span class="s1">&#39;_call&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_to_coro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">_sp_invoke</span><span class="p">(</span><span class="s1">&#39;_call&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">is_coro</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">node</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;_type&#39;</span><span class="p">):</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">_type</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">Coroutine</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">node</span>
            <span class="k">return</span> <span class="n">_sp_invoke</span><span class="p">(</span><span class="s1">&#39;_call&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_name</span> <span class="o">=</span> <span class="s1">&#39;__sp_fn</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_tmp_index</span><span class="p">()</span>
            <span class="n">coro</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tmp_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">_empty_ast_arguments</span><span class="p">(),</span>
                                        <span class="n">decorator_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">returns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                        <span class="n">body</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">node</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">tmp_name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">keywords</span><span class="o">=</span><span class="p">[])</span>

    <span class="k">def</span> <span class="nf">visit_With_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">item_ix</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">item_ix</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">optional_vars</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">optional_vars</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">optional_vars</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">awaited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item_ix</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit_With_item</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">item_ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">body_visited</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span>
            <span class="n">body_visited</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">and</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">_SP_CMS</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">expr</span><span class="p">)</span>
                <span class="n">expr</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">expr</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span> <span class="o">=</span> <span class="n">expr</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">ref</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;Val: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">_SP_CMS</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> cannot be used in a multi-item with&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">_transformer</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">tr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">optional_vars</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AbstractAsyncContextManager</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutine</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncWith</span><span class="p">()</span>
                <span class="n">_copy_params</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">body_visited</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_nodes</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncWith</span><span class="p">()</span>
                <span class="n">_copy_params</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span> <span class="o">=</span> <span class="n">_make_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_mod_name</span><span class="p">,</span> <span class="s1">&#39;_to_acm&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">body_visited</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_nodes</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ref</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">is_async_ctx_manager</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ref</span><span class="o">.</span><span class="n">is_ctx_manager</span><span class="p">())):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncWith</span><span class="p">()</span>
                <span class="n">_copy_params</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ref</span><span class="o">.</span><span class="n">is_ctx_manager</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ref</span><span class="o">.</span><span class="n">is_async_ctx_manager</span><span class="p">()):</span>
                    <span class="c1"># unknown; coerce to async context manager</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span> <span class="o">=</span> <span class="n">_sp_invoke</span><span class="p">(</span><span class="s1">&#39;_to_acm&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">context_expr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">body_visited</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_nodes</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_With</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;Visiting with node </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_With_item</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFor</span><span class="p">()</span>
        <span class="n">_copy_params</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">elts</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">awaited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="n">_make_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_mod_name</span><span class="p">,</span> <span class="s1">&#39;_to_aiter&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">_get_type</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">awaited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="n">elt</span><span class="o">.</span><span class="n">id</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">_get_type</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">awaited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_AnnAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_AugAssign</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_AugAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">_get_type</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">awaited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enter_context</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_context</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enter_context</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visit_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_While</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_If</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Try</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">awaited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_parallel_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;parallel() does not support keyword arguments.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;parallel() needs at least two arguments.&#39;</span><span class="p">)</span>
        <span class="n">call</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;_fn&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">)):</span>
            <span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_coro</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_race_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;race() does not support keyword arguments.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;race() needs at least two arguments.&#39;</span><span class="p">)</span>
        <span class="n">call</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">call</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;_fn&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">)):</span>
            <span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_coro</span><span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Await</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span>
                       <span class="n">r_nodes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">tmp_name</span> <span class="o">=</span> <span class="s1">&#39;__sp_fn</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_tmp_index</span><span class="p">()</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enter_context</span><span class="p">(</span><span class="n">_ContextType</span><span class="o">.</span><span class="n">PAR</span><span class="p">)</span>
            <span class="n">coro</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tmp_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">_empty_ast_arguments</span><span class="p">(),</span>
                                        <span class="n">decorator_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">returns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
            <span class="n">exports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">var_names</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exports</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Nonlocal</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exports</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">exports</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">var_names</span><span class="p">():</span>
                        <span class="n">r_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_assign</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">add_local</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">awaited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">r_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
            <span class="n">call</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;__sp_pctx&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                    <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;_start&#39;</span><span class="p">,</span>
                    <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp_name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">keywords</span><span class="o">=</span><span class="p">[])],</span>
                <span class="n">keywords</span><span class="o">=</span><span class="p">[]</span>
            <span class="p">)</span>
            <span class="n">r_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">call</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exit_context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r_nodes</span>

    <span class="k">def</span> <span class="nf">_make_fork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">r_nodes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">tmp_name</span> <span class="o">=</span> <span class="s1">&#39;__sp_fn</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_tmp_index</span><span class="p">()</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enter_context</span><span class="p">(</span><span class="n">_ContextType</span><span class="o">.</span><span class="n">PAR</span><span class="p">)</span>
            <span class="n">coro</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tmp_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">_empty_ast_arguments</span><span class="p">(),</span>
                                        <span class="n">decorator_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">returns</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
            <span class="n">exports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">var_names</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exports</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Nonlocal</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exports</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">exports</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">crt_context</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">var_names</span><span class="p">():</span>
                        <span class="n">r_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_assign</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
            <span class="n">r_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
            <span class="n">call</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
                <span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_mod_name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                    <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;_start&#39;</span><span class="p">,</span>
                    <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">tmp_name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">keywords</span><span class="o">=</span><span class="p">[])],</span>
                <span class="n">keywords</span><span class="o">=</span><span class="p">[]</span>
            <span class="p">)</span>
            <span class="n">r_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">call</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exit_context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">r_nodes</span>

    <span class="k">def</span> <span class="nf">_visit_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">r_nodes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">r_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">r_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r_nodes</span>


<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">astdump</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">_check_async</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_find_sp</span><span class="p">(</span><span class="n">decorator_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">crt_frame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">decorator_list</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">decorator_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">func</span>
        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name_ref</span> <span class="o">=</span> <span class="n">_find_global</span><span class="p">(</span><span class="n">crt_frame</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_ref</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name_ref</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;stpr&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Cannot find sp module from decorator.&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_MyUnparser</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">_Unparser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cannot visit </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">raise</span>


<span class="k">class</span> <span class="nc">_LineUpdater</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>

    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;lineno&#39;</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">lineno</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;end_lineno&#39;</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">end_lineno</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_update_linenos</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_LineUpdater</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_code</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">c</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Code object not found in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>


<div class="viewcode-block" id="fn">
<a class="viewcode-back" href="../../api/primitives.html#stpr.fn">[docs]</a>
<span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">crt_frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stpr_module_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator for Stpr functions.</span>

<span class="sd">    This decorator is used to enable Stpr functionality in a function or method. Specifically:</span>

<span class="sd">    * The decorated function becomes an async function (i.e., it behaves as if defined with</span>
<span class="sd">      ``async def``.</span>
<span class="sd">    * The Stpr concurrency primitives become available in that function.</span>
<span class="sd">    * Calls to other async functions or methods from the body of the decorated function will</span>
<span class="sd">      automatically be ``await``-ed. This includes calls to other ``stpr.fn`` decorated functions.</span>
<span class="sd">    * When an async iterator is used in a ``for`` statement, the ``for`` statement is</span>
<span class="sd">      transformed to an ``async for``.</span>
<span class="sd">    * When an async context manager is used in a ``with`` statement, the ``with`` statement</span>
<span class="sd">      becomes an ``async with`` statement.</span>
<span class="sd">    * Calls to synchronous functions/methods are automatically executed in a thread pool. Stpr</span>
<span class="sd">      may, heuristically, choose to execute some simple functions inside the asyncio event loop</span>
<span class="sd">      to reduce the overhead of submitting to a thread pool. Multiple sequential synchronous</span>
<span class="sd">      function/method invocations are generally merged into a single task to be submitted to a</span>
<span class="sd">      thread pool.</span>

<span class="sd">    Stpr does most of its analysis statically. However, it is not always possible to fully determine</span>
<span class="sd">    the type of a variable or parameter statically. When Stpr encounters such a situation, it wraps</span>
<span class="sd">    calls into utility functions that dynamically route execution to either the async event loop or</span>
<span class="sd">    to a thread pool.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">crt_frame</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">crt_frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">debug</span><span class="p">,</span> <span class="n">crt_frame</span><span class="p">,</span> <span class="n">stpr_module_name</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Instrumenting </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;__SP_CC&#39;</span><span class="p">):</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_firstlineno</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">stpr_module_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stpr_module_name</span> <span class="o">=</span> <span class="n">_find_sp</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">,</span> <span class="n">crt_frame</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Before instrumentation&#39;</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
                <span class="n">astdump</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">_transform</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">crt_frame</span><span class="o">.</span><span class="n">f_back</span><span class="p">,</span> <span class="n">stpr_module_name</span><span class="p">)</span>
            <span class="n">nlines</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">end_lineno</span> <span class="o">-</span> <span class="n">t2</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span>
            <span class="n">t2</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="n">lineno</span>
            <span class="n">t2</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">end_lineno</span> <span class="o">=</span> <span class="n">lineno</span> <span class="o">+</span> <span class="n">nlines</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
            <span class="n">_update_linenos</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">_print</span><span class="p">(</span><span class="s1">&#39;After instrumentation&#39;</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>
                <span class="n">astdump</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
            <span class="n">up</span> <span class="o">=</span> <span class="n">_MyUnparser</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="n">astdump</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">_get_code</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">co_consts</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">__SP_CC</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inner</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inner</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>



<div class="viewcode-block" id="seq">
<a class="viewcode-back" href="../../api/primitives.html#stpr.seq">[docs]</a>
<span class="k">class</span> <span class="nc">seq</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs statements sequentially.</span>

<span class="sd">    Syntax:</span>

<span class="sd">    .. code-block:: Python</span>

<span class="sd">        with stpr.seq:</span>
<span class="sd">            stmt1</span>
<span class="sd">            stmt2</span>
<span class="sd">            ...</span>
<span class="sd">            stmtN</span>

<span class="sd">    Runs statements in sequence: ``stmt1`` will be run first, followed by ``stmt2`` and so on.</span>

<span class="sd">    .. uml::</span>
<span class="sd">        :align: center</span>

<span class="sd">        @startuml</span>
<span class="sd">        &lt;style&gt;</span>
<span class="sd">            activityDiagram {</span>
<span class="sd">                .blank {</span>
<span class="sd">                    LineColor #ffffff</span>
<span class="sd">                    BackgroundColor #ffffff</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &lt;/style&gt;</span>
<span class="sd">        start</span>
<span class="sd">        fork</span>
<span class="sd">            :stmt1;</span>
<span class="sd">            :stmt2;</span>
<span class="sd">            :...; &lt;&lt;blank&gt;&gt;</span>
<span class="sd">            :stmtN;</span>
<span class="sd">        end fork</span>
<span class="sd">        stop</span>
<span class="sd">        @enduml</span>

<span class="sd">    When an exception is raised by the currently executing statement, the execution of the remaining</span>
<span class="sd">    statements is aborted and ``stpr.seq`` re-raises the exception raised by the statement.</span>

<span class="sd">    Running statements sequentially is the default in a Stpr function so including a ``stpr.seq``</span>
<span class="sd">    is redundant if all statements in a function are to be run sequentially. The typical usage</span>
<span class="sd">    scenario of ``stpr.seq`` is when it is nested inside :py:func:`stpr.parallel` or other similar</span>
<span class="sd">    concurrency primitives.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.4f</span><span class="s1"> enter </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_ts</span><span class="p">(),</span> <span class="bp">self</span><span class="p">),</span> <span class="n">Color</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.4f</span><span class="s1"> exit </span><span class="si">%s</span><span class="s1"> (exc: </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_ts</span><span class="p">(),</span> <span class="bp">self</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">),</span> <span class="n">Color</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_transformer</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_Transformer</span><span class="o">.</span><span class="n">_seq</span></div>



<div class="viewcode-block" id="parallel">
<a class="viewcode-back" href="../../api/primitives.html#stpr.parallel">[docs]</a>
<span class="k">class</span> <span class="nc">parallel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs statements in parallel.</span>

<span class="sd">    Syntax:</span>

<span class="sd">    .. code-block:: Python</span>

<span class="sd">        with stpr.parallel:</span>
<span class="sd">            stmt1</span>
<span class="sd">            stmt2</span>
<span class="sd">            ...</span>
<span class="sd">            stmtN</span>

<span class="sd">    Runs ``stmt1``, ``stmt2``, ..., and ``stmtN`` in parallel and waits for all of them to complete.</span>

<span class="sd">    .. uml::</span>
<span class="sd">        :align: center</span>

<span class="sd">        @startuml</span>
<span class="sd">        &lt;style&gt;</span>
<span class="sd">            activityDiagram {</span>
<span class="sd">                .blank {</span>
<span class="sd">                    LineColor #ffffff</span>
<span class="sd">                    BackgroundColor #ffffff</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &lt;/style&gt;</span>
<span class="sd">        start</span>
<span class="sd">        fork</span>
<span class="sd">            :stmt1;</span>
<span class="sd">        fork again</span>
<span class="sd">            :stmt2;</span>
<span class="sd">        fork again</span>
<span class="sd">            -[#white]-&gt;</span>
<span class="sd">            :...; &lt;&lt;blank&gt;&gt;</span>
<span class="sd">            -[#white]-&gt;</span>
<span class="sd">        fork again</span>
<span class="sd">            :stmtN;</span>
<span class="sd">        end fork</span>
<span class="sd">        stop</span>
<span class="sd">        @enduml</span>

<span class="sd">    If one or more statements raise an exception, the remaining running statements are canceled and</span>
<span class="sd">    the first detected exception is re-raised. This is in contrast with</span>
<span class="sd">    :py:class:`asyncio.TaskGroup`, which raises an exception that combines all detected exceptions</span>
<span class="sd">    from its tasks.</span>

<span class="sd">    An alternative syntax is to use ``stpr.parallel`` as a function:</span>

<span class="sd">    .. code-block:: Python</span>

<span class="sd">        r1, r2, ..., rN = stpr.parallel(f1(), f2(), ..., fN())</span>

<span class="sd">    In this case, ``f1``, ``f2``, ..., and ``fN`` will be executed in parallel and their return</span>
<span class="sd">    values assigned, respectively, to ``r1``, ``r2``, ..., and ``rN``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tg</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TaskGroup</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.4f</span><span class="s1"> enter </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_ts</span><span class="p">(),</span> <span class="bp">self</span><span class="p">),</span> <span class="n">Color</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tg</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.4f</span><span class="s1"> exit </span><span class="si">%s</span><span class="s1"> (exc: </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_ts</span><span class="p">(),</span> <span class="bp">self</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">),</span> <span class="n">Color</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tg</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ExceptionGroup</span> <span class="k">as</span> <span class="n">eg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">eg</span><span class="o">.</span><span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="kn">from</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coro</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Task</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tg</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_transformer</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_Transformer</span><span class="o">.</span><span class="n">_parallel</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fn</span><span class="p">(</span><span class="o">*</span><span class="n">coros</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="o">...</span><span class="p">]:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">parallel</span><span class="p">()</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">coro</span> <span class="ow">in</span> <span class="n">coros</span><span class="p">:</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">_start</span><span class="p">(</span><span class="n">coro</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">])</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;r: </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">BRIGHT_RED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span></div>



<span class="k">class</span> <span class="nc">_RaceTaskGroup</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">TaskGroup</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_on_task_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;task_done: </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_on_task_done</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_done</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;result: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">GREEN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_abort</span><span class="p">()</span>


<div class="viewcode-block" id="race">
<a class="viewcode-back" href="../../api/primitives.html#stpr.race">[docs]</a>
<span class="k">class</span> <span class="nc">race</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Races a set of functions.</span>

<span class="sd">    Syntax:</span>

<span class="sd">    .. code-block:: Python</span>

<span class="sd">        r = stpr.race(f1(), f2(), ..., fN())</span>

<span class="sd">    Functions ``f1``, ``f2``, ..., and ``fN`` are executed in parallel. The first function to</span>
<span class="sd">    complete successfully wins the race and its return value is returned by ``stpr.race``. The</span>
<span class="sd">    execution of the remaining functions is then canceled. If any function raises an exception</span>
<span class="sd">    after the first function completes, the exception is ignored. If one or more functions raise an</span>
<span class="sd">    exception before any function completes successfully, ``stpr.race`` re-raises that exception</span>
<span class="sd">    and cancels the execution of the remaining functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fn</span><span class="p">(</span><span class="o">*</span><span class="n">coros</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tg</span> <span class="o">=</span> <span class="n">_RaceTaskGroup</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">tg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">coro</span> <span class="ow">in</span> <span class="n">coros</span><span class="p">:</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tg</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">_result</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;r: </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">BRIGHT_RED</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span></div>



<div class="viewcode-block" id="parallelFor">
<a class="viewcode-back" href="../../api/primitives.html#stpr.parallelFor">[docs]</a>
<span class="k">class</span> <span class="nc">parallelFor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterates over a sequence in parallel.</span>

<span class="sd">    Syntax:</span>

<span class="sd">    .. code-block:: Python</span>

<span class="sd">        with stpr.parallelFor(iterable) as var:</span>
<span class="sd">            stmt1</span>
<span class="sd">            stmt2</span>
<span class="sd">            ...</span>
<span class="sd">            stmtN</span>

<span class="sd">    For each value produced by the ``iterable``, ``var`` is assigned that value and the statements</span>
<span class="sd">    ``stmt1``, ``stmt2``, ..., and ``stmtN`` are executed sequentially. The execution of each</span>
<span class="sd">    iteration is started as soon as the iterable produces the corresponding value. If the</span>
<span class="sd">    ``iterable`` produces all its values at once and there is a total of ``M`` values, the</span>
<span class="sd">    following diagram applies:</span>

<span class="sd">    .. uml::</span>
<span class="sd">        :align: center</span>

<span class="sd">        @startuml</span>
<span class="sd">        &lt;style&gt;</span>
<span class="sd">            activityDiagram {</span>
<span class="sd">                .blank {</span>
<span class="sd">                    LineColor #ffffff</span>
<span class="sd">                    BackgroundColor #ffffff</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &lt;/style&gt;</span>
<span class="sd">        start</span>
<span class="sd">        fork</span>
<span class="sd">            :var = iterable[0];</span>
<span class="sd">            :stmt1;</span>
<span class="sd">            :stmt2;</span>
<span class="sd">            :...; &lt;&lt;blank&gt;&gt;</span>
<span class="sd">            :stmtN;</span>
<span class="sd">        fork again</span>
<span class="sd">            :var = iterable[1];</span>
<span class="sd">            :stmt1;</span>
<span class="sd">            :stmt2;</span>
<span class="sd">            :...; &lt;&lt;blank&gt;&gt;</span>
<span class="sd">            :stmtN;</span>
<span class="sd">        fork again</span>
<span class="sd">            -[#white]-&gt;</span>
<span class="sd">            :...; &lt;&lt;blank&gt;&gt;</span>
<span class="sd">            -[#white]-&gt;</span>
<span class="sd">        fork again</span>
<span class="sd">            :var = iterable[M - 1];</span>
<span class="sd">            :stmt1;</span>
<span class="sd">            :stmt2;</span>
<span class="sd">            :...; &lt;&lt;blank&gt;&gt;</span>
<span class="sd">            :stmtN;</span>
<span class="sd">        end fork</span>
<span class="sd">        stop</span>
<span class="sd">        @enduml</span>

<span class="sd">    If any of the statements raise an exception in any of the iterations, ``stpr.parallelFor``</span>
<span class="sd">    cancels all running iterations, stops processing values from ``iterator``, and re-raises that</span>
<span class="sd">    exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">maxp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param it: The iterable to iterate over.</span>
<span class="sd">        :param maxp: If specified, at most ``maxp`` parallel iterations will be active at any given</span>
<span class="sd">            time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_transformer</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_Transformer</span><span class="o">.</span><span class="n">_parallelFor</span></div>



<div class="viewcode-block" id="fork">
<a class="viewcode-back" href="../../api/primitives.html#stpr.fork">[docs]</a>
<span class="k">class</span> <span class="nc">fork</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs a statement asynchronously.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.4f</span><span class="s1"> enter </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_ts</span><span class="p">(),</span> <span class="bp">self</span><span class="p">),</span> <span class="n">Color</span><span class="o">.</span><span class="n">BLUE</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.4f</span><span class="s1"> exit </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_ts</span><span class="p">(),</span> <span class="bp">self</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_transformer</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_Transformer</span><span class="o">.</span><span class="n">_fork</span></div>



<span class="n">_SP_CMS</span> <span class="o">=</span> <span class="p">[</span><span class="n">seq</span><span class="p">,</span> <span class="n">parallel</span><span class="p">,</span> <span class="n">parallelFor</span><span class="p">,</span> <span class="n">fork</span><span class="p">]</span>

<span class="n">_SP_FNS</span> <span class="o">=</span> <span class="p">[</span><span class="n">parallel</span><span class="p">,</span> <span class="n">race</span><span class="p">]</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
        <div id="right_sidebar">
            <h4>Page contents</h4>
            <div class="page_toc">
                
            </div>
        </div>
    

      <div class="clearer"></div>
    </div>
    <div class="button_nav_wrapper">
        <div class="button_nav">
            <div class="left">
                
            </div>

            <div class="right">
                
            </div>
        </div>
    </div>

        

  </body>
</html>